<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: GDB | th0x4c 備忘録]]></title>
  <link href="http://th0x4c.github.com/blog/categories/gdb/atom.xml" rel="self"/>
  <link href="http://th0x4c.github.com/"/>
  <updated>2013-06-28T23:41:32+09:00</updated>
  <id>http://th0x4c.github.com/</id>
  <author>
    <name><![CDATA[Takashi Hashizume]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[[GDB] Linux x86-64 の呼出規約(calling convention)を gdb で確認する]]></title>
    <link href="http://th0x4c.github.com/blog/2013/04/10/gdb-calling-convention/"/>
    <updated>2013-04-10T21:01:00+09:00</updated>
    <id>http://th0x4c.github.com/blog/2013/04/10/gdb-calling-convention</id>
    <content type="html"><![CDATA[<h2>目的</h2>

<p>Linux x86-64 の呼出規約(calling convention)を gdb で確認する。</p>

<h2>環境</h2>

<ul>
<li>OS: CentOS 5.5</li>
<li>Kernel: 2.6.18-194.el5 x86_64</li>
<li>GCC: gcc 4.1.2 20080704</li>
<li>GDB: GNU gdb 7.0.1-23.el5</li>
</ul>


<h2>呼出規約(calling convention)</h2>

<p>プログラムで関数を呼び出す際に、レジスタやスタックを使いどのように引数を渡すか、戻り値をどのように受け取るかは呼出規約(calling convention)で決められている。</p>

<p>Linux x86-64 では、以下のような呼出規約になっている。
(Wikepedia <a href="http://en.wikipedia.org/wiki/X86_calling_conventions#x86-64_calling_conventions">x86 calling conventions</a>, <a href="http://ja.wikipedia.org/wiki/%E5%91%BC%E5%87%BA%E8%A6%8F%E7%B4%84#System_V_AMD64_ABI_.E5.91.BC.E5.87.BA.E8.A6.8F.E7.B4.84">呼出規約</a> から抜粋)</p>

<blockquote><p>The calling convention of the System V AMD64 ABI is followed on Solaris,
GNU/Linux, FreeBSD, and other non-Microsoft operating systems.
The first six integer or pointer arguments are passed in registers RDI, RSI,
RDX, RCX, R8, and R9, while XMM0, XMM1, XMM2, XMM3, XMM4, XMM5, XMM6 and XMM7
are used for floating point arguments.
For system calls, R10 is used instead of RCX.
As in the Microsoft x64 calling convention, additional arguments are passed
on the stack and the return value is stored in RAX.</p></blockquote>

<ul>
<li>整数・ポインタ引数: RDI, RSI, RDX, RCX, R8, R9</li>
<li>浮動小数点引数: XMM0, XMM1, XMM2, XMM3, XMM4, XMM5, XMM6, XMM7</li>
<li>戻り値: RAX</li>
<li>システムコールでは RCX の代わりに R10 を使用</li>
<li>レジスタだけでは引数の数が不足する場合はスタックを利用</li>
</ul>


<p>より詳細には <a href="http://x86-64.org/documentation/abi.pdf">System V Application Binary Interface AMD64 Architecture Processor Supplement</a> を参照。</p>

<h2>gdb による確認</h2>

<p>上記の呼出規約を実際のプログラムで確認してみる。</p>

<p>使用するサンプルプログラムは以下。</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">include</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">stdio</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="kt">int</span> <span class="n">sum</span><span class="p">(</span><span class="kt">int</span> <span class="n">a1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a3</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a4</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a5</span><span class="p">,</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>    <span class="kt">int</span> <span class="n">a6</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a7</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a8</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a9</span><span class="p">);</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="kt">void</span> <span class="n">func</span><span class="p">();</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="kt">int</span> <span class="n">sum</span><span class="p">(</span><span class="kt">int</span> <span class="n">a1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a3</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a4</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a5</span><span class="p">,</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>    <span class="kt">int</span> <span class="n">a6</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a7</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a8</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a9</span><span class="p">)</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9999</span><span class="p">;</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="n">s</span> <span class="o">=</span> <span class="n">a1</span> <span class="o">+</span> <span class="n">a2</span> <span class="o">+</span> <span class="n">a3</span> <span class="o">+</span> <span class="n">a4</span> <span class="o">+</span> <span class="n">a5</span> <span class="o">+</span> <span class="n">a6</span> <span class="o">+</span> <span class="n">a7</span> <span class="o">+</span> <span class="n">a8</span> <span class="o">+</span> <span class="n">a9</span><span class="p">;</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="kt">void</span> <span class="n">func</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="n">ret</span> <span class="o">=</span> <span class="n">sum</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">99</span><span class="p">);</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="n">printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">sum</span><span class="o">:</span> <span class="o">%</span><span class="n">d</span><span class="err">\</span><span class="n">n</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;,</span> <span class="n">ret</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">func</span><span class="p">();</span>
</span><span class='line'>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>実行結果は以下。</p>

<pre><code>$ gcc -g -o sample1 sample1.c
$ ./sample1
sum: 495
</code></pre>

<p>gdb から、関数 func から関数 sum を呼び出している個所を確認する。
<code>disas/m</code> というふうに修飾子 /m を指定するとソースと共に表示されて分かりやすくなる。
(ちなみに <code>objdump -d -S ./sample1</code> としてもソースと関数の逆アセンブル結果が出力される)</p>

<pre><code>$ gdb ./sample1
(gdb) set height 0
(gdb) disas/m func
Dump of assembler code for function func:
18      {
0x00000000004004da &lt;func+0&gt;:    push   %rbp
0x00000000004004db &lt;func+1&gt;:    mov    %rsp,%rbp
0x00000000004004de &lt;func+4&gt;:    sub    $0x30,%rsp

19        int ret = -1;
0x00000000004004e2 &lt;func+8&gt;:    movl   $0xffffffff,-0x4(%rbp)

20
21        ret = sum(11, 22, 33, 44, 55, 66, 77, 88, 99);
0x00000000004004e9 &lt;func+15&gt;:   movl   $0x63,0x10(%rsp)  &lt;== 第9引数(0x63 = 99) を スタック+0x10 の位置に格納
0x00000000004004f1 &lt;func+23&gt;:   movl   $0x58,0x8(%rsp)   &lt;== 第8引数(0x58 = 88) を スタック+0x8  の位置に格納
0x00000000004004f9 &lt;func+31&gt;:   movl   $0x4d,(%rsp)      &lt;== 第7引数(0x4d = 77) を スタック      の位置に格納
0x0000000000400500 &lt;func+38&gt;:   mov    $0x42,%r9d        &lt;== 第6引数(0x42 = 66) を R9  に格納
0x0000000000400506 &lt;func+44&gt;:   mov    $0x37,%r8d        &lt;== 第5引数(0x37 = 55) を R8  に格納
0x000000000040050c &lt;func+50&gt;:   mov    $0x2c,%ecx        &lt;== 第4引数(0x2c = 44) を ECX に格納
0x0000000000400511 &lt;func+55&gt;:   mov    $0x21,%edx        &lt;== 第3引数(0x21 = 33) を EDX に格納
0x0000000000400516 &lt;func+60&gt;:   mov    $0x16,%esi        &lt;== 第2引数(0x16 = 22) を RSI に格納
0x000000000040051b &lt;func+65&gt;:   mov    $0xb,%edi         &lt;== 第1引数( 0xb = 11) を RDI に格納
0x0000000000400520 &lt;func+70&gt;:   callq  0x400498 &lt;sum&gt;    &lt;== 関数 sum を呼出
0x0000000000400525 &lt;func+75&gt;:   mov    %eax,-0x4(%rbp)   &lt;== 戻り値を RAX から受け取る

22
23        printf("sum: %d\n", ret);
0x0000000000400528 &lt;func+78&gt;:   mov    -0x4(%rbp),%esi
0x000000000040052b &lt;func+81&gt;:   mov    $0x400658,%edi
0x0000000000400530 &lt;func+86&gt;:   mov    $0x0,%eax
0x0000000000400535 &lt;func+91&gt;:   callq  0x400398 &lt;printf@plt&gt;

24      }
0x000000000040053a &lt;func+96&gt;:   leaveq
0x000000000040053b &lt;func+97&gt;:   retq

End of assembler dump.
</code></pre>

<p>確かに呼出規約通り、第1引数～第6引数まで RDI, RSI, RDX, RCX, R8, R9 を順に使用して、
残りの第7引数～第9引数はスタックを利用している。戻り値は RAX に格納されている。</p>

<p>ちなみに呼び出される関数 sum の disas の結果は以下</p>

<pre><code>(gdb) disas/m sum
Dump of assembler code for function sum:
9       {
0x0000000000400498 &lt;sum+0&gt;:     push   %rbp
0x0000000000400499 &lt;sum+1&gt;:     mov    %rsp,%rbp
0x000000000040049c &lt;sum+4&gt;:     mov    %edi,-0x14(%rbp)
0x000000000040049f &lt;sum+7&gt;:     mov    %esi,-0x18(%rbp)
0x00000000004004a2 &lt;sum+10&gt;:    mov    %edx,-0x1c(%rbp)
0x00000000004004a5 &lt;sum+13&gt;:    mov    %ecx,-0x20(%rbp)
0x00000000004004a8 &lt;sum+16&gt;:    mov    %r8d,-0x24(%rbp)
0x00000000004004ac &lt;sum+20&gt;:    mov    %r9d,-0x28(%rbp)

10        int s = -9999;
0x00000000004004b0 &lt;sum+24&gt;:    movl   $0xffffd8f1,-0x4(%rbp)

11
12        s = a1 + a2 + a3 + a4 + a5 + a6 + a7 + a8 + a9;
0x00000000004004b7 &lt;sum+31&gt;:    mov    -0x18(%rbp),%eax
0x00000000004004ba &lt;sum+34&gt;:    add    -0x14(%rbp),%eax
0x00000000004004bd &lt;sum+37&gt;:    add    -0x1c(%rbp),%eax
0x00000000004004c0 &lt;sum+40&gt;:    add    -0x20(%rbp),%eax
0x00000000004004c3 &lt;sum+43&gt;:    add    -0x24(%rbp),%eax
0x00000000004004c6 &lt;sum+46&gt;:    add    -0x28(%rbp),%eax
0x00000000004004c9 &lt;sum+49&gt;:    add    0x10(%rbp),%eax
0x00000000004004cc &lt;sum+52&gt;:    add    0x18(%rbp),%eax
0x00000000004004cf &lt;sum+55&gt;:    add    0x20(%rbp),%eax
0x00000000004004d2 &lt;sum+58&gt;:    mov    %eax,-0x4(%rbp)

13
14        return s;
0x00000000004004d5 &lt;sum+61&gt;:    mov    -0x4(%rbp),%eax

15      }
0x00000000004004d8 &lt;sum+64&gt;:    leaveq
0x00000000004004d9 &lt;sum+65&gt;:    retq

End of assembler dump.
</code></pre>

<p>関数 sum で break させて、レジスタの状態やスタックを確認すれば引数の値が分かる。</p>

<pre><code>(gdb) b sum
Breakpoint 1 at 0x4004b0: file sample1.c, line 10.
(gdb) run
Starting program: /home/hashi/tmp/sample1

Breakpoint 1, sum (a1=11, a2=22, a3=33, a4=44, a5=55, a6=66, a7=77, a8=88, a9=99) at sample1.c:10
10        int s = -9999;
(gdb) info reg
rax            0x0      0
rbx            0x3e1c81bbc0     266766236608
rcx            0x2c     44                        &lt;== 第4引数
rdx            0x21     33                        &lt;== 第3引数
rsi            0x16     22                        &lt;== 第2引数
rdi            0xb      11                        &lt;== 第1引数
rbp            0x7fffffffe270   0x7fffffffe270
rsp            0x7fffffffe270   0x7fffffffe270
r8             0x37     55                        &lt;== 第5引数
r9             0x42     66                        &lt;== 第6引数
r10            0x0      0
r11            0x3e1ca1d8a0     266768341152
r12            0x0      0
r13            0x7fffffffe3b0   140737488348080
r14            0x0      0
r15            0x0      0
rip            0x4004b0 0x4004b0 &lt;sum+24&gt;         &lt;== sum+20 までの処理が終わっていて次の処理は sum+24
eflags         0x202    [ IF ]
cs             0x33     51
ss             0x2b     43
ds             0x0      0
es             0x0      0
fs             0x0      0
gs             0x0      0
fctrl          0x37f    895
fstat          0x0      0
ftag           0xffff   65535
fiseg          0x0      0
fioff          0x0      0
foseg          0x0      0
fooff          0x0      0
fop            0x0      0
mxcsr          0x1f80   [ IM DM ZM OM UM PM ]
(gdb) x/6gx $rbp
0x7fffffffe270: 0x00007fffffffe2b0      0x0000000000400525
0x7fffffffe280: 0x000000000000004d      0x0000000000000058
                          ~~~~~~~~第7引数         ~~~~~~~~第8引数
0x7fffffffe290: 0x2cb4304900000063      0x00000000004005a7
                          ~~~~~~~~第9引数
</code></pre>

<p>スタック上の値を確認するのに <code>x/6gx $rbp</code> としているのは、関数で break したときは関数の最初の方の処理(サブルーチンプロローグ)まで
終わっているが、普通はここまでで引数をスタックに積んだ後、</p>

<ul>
<li><code>call &lt;function&gt;</code> : スタックに戻り先の命令アドレスを積んで関数を呼ぶ(rsp が +0x8 される)</li>
<li><code>push %rbp</code> : ベースポインタ(rbp)の値が push され、スタックに保存される(rsp が +0x8 される)</li>
<li><code>mov %rsp,%rbp</code> : スタックポインタ(rsp)の値をベースポインタ(rbp)に保存する</li>
<li>(<code>sub $0xXX,%rsp</code> : ローカル変数を保持するためにスタックを上げる)</li>
</ul>


<p>という処理が一般的に行われるためである。結果としてスタックに積まれた引数は <code>$rbp + 0x10</code> の位置から、第7引数が <code>$rbp + 0x10</code>, 第8引数が <code>$rbp + 0x18</code>, 第9引数が <code>$rbp + 0x20</code>,&hellip; というふうに存在することになる。</p>

<p>関数 sum から返った後に レジスタ RAX にて戻り値が分かる。</p>

<pre><code>(gdb) finish
Run till exit from #0  sum (a1=11, a2=22, a3=33, a4=44, a5=55, a6=66, a7=77, a8=88, a9=99) at sample1.c:12
0x0000000000400525 in func () at sample1.c:21
21        ret = sum(11, 22, 33, 44, 55, 66, 77, 88, 99);
Value returned is $1 = 495
(gdb) p $rax
$2 = 495
</code></pre>

<h2>詳細確認</h2>

<p>せっかくなので、関数 func から関数 sum を呼び出しているところを逆アセンブルの結果から詳しく追ってみる。</p>

<p>初期状態(関数 func が呼ばれる直前)</p>

<pre><code>rbp            0x7fffffffe2d0   0x7fffffffe2d0
rsp            0x7fffffffe2c0   0x7fffffffe2c0

        0x7fffffffe2b8 +------------------+
                       |                  |
rsp --&gt; 0x7fffffffe2c0 +------------------+
                       |                  |
        0x7fffffffe2c8 +------------------+
                       |                  |
rbp --&gt; 0x7fffffffe2d0 +------------------+
                       |                  |
        0x7fffffffe2d8 +------------------+
</code></pre>

<p>関数 main から関数 func を呼ぶ</p>

<pre><code>0x0000000000400550 &lt;main+20&gt;:   callq  0x4004da &lt;func&gt;  &lt;== 関数 func を呼出
</code></pre>

<p>この命令後のレジスタの状態</p>

<pre><code>rbp            0x7fffffffe2d0   0x7fffffffe2d0
rsp            0x7fffffffe2b8   0x7fffffffe2b8

rip            0x4004da 0x4004da &lt;func&gt;

rsp --&gt; 0x7fffffffe2b8 +------------------+
                       |0x0000000000400555| &lt;== 関数 main の戻り先命令アドレス
        0x7fffffffe2c0 +------------------+
                       |                  |
        0x7fffffffe2c8 +------------------+
                       |                  |
rbp --&gt; 0x7fffffffe2d0 +------------------+
                       |                  |
        0x7fffffffe2d8 +------------------+
</code></pre>

<p>関数 func が呼び出され、ここから関数 func に入る。</p>

<pre><code>Dump of assembler code for function func:
18      {
0x00000000004004da &lt;func+0&gt;:    push   %rbp
0x00000000004004db &lt;func+1&gt;:    mov    %rsp,%rbp
0x00000000004004de &lt;func+4&gt;:    sub    $0x30,%rsp
</code></pre>

<p>この命令後のレジスタの状態</p>

<pre><code>rbp            0x7fffffffe2b0   0x7fffffffe2b0
rsp            0x7fffffffe280   0x7fffffffe280

rsp --&gt; 0x7fffffffe280 +------------------+ &lt;== ローカル変数を保持するためにスタックを上げる
                       |                  |
        0x7fffffffe288 +------------------+
                       |                  |
        0x7fffffffe290 +------------------+
                       |                  |
        0x7fffffffe298 +------------------+
                       |                  |
        0x7fffffffe2a0 +------------------+
                       |                  |
        0x7fffffffe2a8 +------------------+
                       |                  |
rbp --&gt; 0x7fffffffe2b0 +------------------+ &lt;== 元のスタックの位置がベースポインタに保存される
                       |0x00007fffffffe2d0| &lt;== ベースポインタの値がスタックに保存される
        0x7fffffffe2b8 +------------------+
                       |0x0000000000400555|
        0x7fffffffe2c0 +------------------+
                       |                  |
        0x7fffffffe2c8 +------------------+
                       |                  |
        0x7fffffffe2d0 +------------------+
                       |                  |
        0x7fffffffe2d8 +------------------+
</code></pre>

<p>進める</p>

<pre><code>19        int ret = -1;
0x00000000004004e2 &lt;func+8&gt;:    movl   $0xffffffff,-0x4(%rbp)
</code></pre>

<p>この命令後のレジスタの状態</p>

<pre><code>rbp            0x7fffffffe2b0   0x7fffffffe2b0
rsp            0x7fffffffe280   0x7fffffffe280

rsp --&gt; 0x7fffffffe280 +------------------+
                       |                  |
        0x7fffffffe288 +------------------+
                       |                  |
        0x7fffffffe290 +------------------+
                       |                  |
        0x7fffffffe298 +------------------+
                       |                  |
        0x7fffffffe2a0 +------------------+
                       |                  |
        0x7fffffffe2a8 +------------------+
                       |        0xffffffff|
rbp --&gt; 0x7fffffffe2b0 +------------------+
                       |0x00007fffffffe2d0|
        0x7fffffffe2b8 +------------------+
                       |0x0000000000400555|
        0x7fffffffe2c0 +------------------+
                       |                  |
        0x7fffffffe2c8 +------------------+
                       |                  |
        0x7fffffffe2d0 +------------------+
                       |                  |
        0x7fffffffe2d8 +------------------+
</code></pre>

<p>進める</p>

<pre><code>20
21        ret = sum(11, 22, 33, 44, 55, 66, 77, 88, 99);
0x00000000004004e9 &lt;func+15&gt;:   movl   $0x63,0x10(%rsp)  &lt;== 第9引数(0x63 = 99) を スタック+0x10 の位置に格納
0x00000000004004f1 &lt;func+23&gt;:   movl   $0x58,0x8(%rsp)   &lt;== 第8引数(0x58 = 88) を スタック+0x8  の位置に格納
0x00000000004004f9 &lt;func+31&gt;:   movl   $0x4d,(%rsp)      &lt;== 第7引数(0x4d = 77) を スタック      の位置に格納
0x0000000000400500 &lt;func+38&gt;:   mov    $0x42,%r9d        &lt;== 第6引数(0x42 = 66) を R9  に格納
0x0000000000400506 &lt;func+44&gt;:   mov    $0x37,%r8d        &lt;== 第5引数(0x37 = 55) を R8  に格納
0x000000000040050c &lt;func+50&gt;:   mov    $0x2c,%ecx        &lt;== 第4引数(0x2c = 44) を ECX に格納
0x0000000000400511 &lt;func+55&gt;:   mov    $0x21,%edx        &lt;== 第3引数(0x21 = 33) を EDX に格納
0x0000000000400516 &lt;func+60&gt;:   mov    $0x16,%esi        &lt;== 第2引数(0x16 = 22) を RSI に格納
0x000000000040051b &lt;func+65&gt;:   mov    $0xb,%edi         &lt;== 第1引数( 0xb = 11) を RDI に格納
</code></pre>

<p>この命令後のレジスタの状態</p>

<pre><code>rcx            0x2c     44                  &lt;== 第4引数
rdx            0x21     33                  &lt;== 第3引数
rsi            0x16     22                  &lt;== 第2引数
rdi            0xb      11                  &lt;== 第1引数
rbp            0x7fffffffe2b0   0x7fffffffe2b0
rsp            0x7fffffffe280   0x7fffffffe280
r8             0x37     55                  &lt;== 第5引数
r9             0x42     66                  &lt;== 第6引数

rsp --&gt; 0x7fffffffe280 +------------------+
                       |0x0000004d        | &lt;== 第7引数
        0x7fffffffe288 +------------------+
                       |0x00000058        | &lt;== 第8引数
        0x7fffffffe290 +------------------+
                       |0x00000063        | &lt;== 第9引数
        0x7fffffffe298 +------------------+
                       |                  |
        0x7fffffffe2a0 +------------------+
                       |                  |
        0x7fffffffe2a8 +------------------+
                       |        0xffffffff|
rbp --&gt; 0x7fffffffe2b0 +------------------+
                       |0x00007fffffffe2d0|
        0x7fffffffe2b8 +------------------+
                       |0x0000000000400555|
        0x7fffffffe2c0 +------------------+
                       |                  |
        0x7fffffffe2c8 +------------------+
                       |                  |
        0x7fffffffe2d0 +------------------+
                       |                  |
        0x7fffffffe2d8 +------------------+
</code></pre>

<p>進める</p>

<pre><code>0x0000000000400520 &lt;func+70&gt;:   callq  0x400498 &lt;sum&gt;    &lt;== 関数 sum を呼出
</code></pre>

<p>この命令後のレジスタの状態</p>

<pre><code>rcx            0x2c     44
rdx            0x21     33
rsi            0x16     22
rdi            0xb      11
rbp            0x7fffffffe2b0   0x7fffffffe2b0
rsp            0x7fffffffe278   0x7fffffffe278
r8             0x37     55
r9             0x42     66

rip            0x400498 0x400498 &lt;sum&gt;  &lt;== 次は関数 sum の命令を呼ぶ

rsp --&gt; 0x7fffffffe278 +------------------+
                       |0x0000000000400525| &lt;== 関数 func の戻り先命令アドレス
        0x7fffffffe280 +------------------+
                       | 0x0000004d       |
        0x7fffffffe288 +------------------+
                       | 0x00000058       |
        0x7fffffffe290 +------------------+
                       | 0x00000063       |
        0x7fffffffe298 +------------------+
                       |                  |
        0x7fffffffe2a0 +------------------+
                       |                  |
        0x7fffffffe2a8 +------------------+
                       |       0xffffffff |
rbp --&gt; 0x7fffffffe2b0 +------------------+
                       |0x00007fffffffe2d0|
        0x7fffffffe2b8 +------------------+
                       |0x0000000000400555|
        0x7fffffffe2c0 +------------------+
                       |                  |
        0x7fffffffe2c8 +------------------+
                       |                  |
        0x7fffffffe2d0 +------------------+
                       |                  |
        0x7fffffffe2d8 +------------------+
</code></pre>

<p>ここから関数 sum に入る</p>

<pre><code>Dump of assembler code for function sum:
9       {
0x0000000000400498 &lt;sum+0&gt;:     push   %rbp
0x0000000000400499 &lt;sum+1&gt;:     mov    %rsp,%rbp
0x000000000040049c &lt;sum+4&gt;:     mov    %edi,-0x14(%rbp)
0x000000000040049f &lt;sum+7&gt;:     mov    %esi,-0x18(%rbp)
0x00000000004004a2 &lt;sum+10&gt;:    mov    %edx,-0x1c(%rbp)
0x00000000004004a5 &lt;sum+13&gt;:    mov    %ecx,-0x20(%rbp)
0x00000000004004a8 &lt;sum+16&gt;:    mov    %r8d,-0x24(%rbp)
0x00000000004004ac &lt;sum+20&gt;:    mov    %r9d,-0x28(%rbp)
</code></pre>

<p>この命令後のレジスタの状態</p>

<pre><code>rcx            0x2c     44
rdx            0x21     33
rsi            0x16     22
rdi            0xb      11
rbp            0x7fffffffe270   0x7fffffffe270
rsp            0x7fffffffe270   0x7fffffffe270
r8             0x37     55
r9             0x42     66

        0x7fffffffe248 +------------------+
                       |0x00000042 0x00000037| &lt;== 66 55
        0x7fffffffe250 +------------------+
                       |0x0000002c 0x00000021| &lt;== 44 33
        0x7fffffffe258 +------------------+
                       |0x00000016 0x0000000b| &lt;== 22 11
        0x7fffffffe260 +------------------+
                       |                  |
        0x7fffffffe268 +------------------+
                       |                  |
rsp +--&gt;0x7fffffffe270 +------------------+ &lt;== 元のスタックの位置がベースポインタに保存される
rbp +                  |0x00007fffffffe2b0| &lt;== ベースポインタの値がスタックに保存される
        0x7fffffffe278 +------------------+
                       |0x0000000000400525|
        0x7fffffffe280 +------------------+
                       |0x0000004d        |
        0x7fffffffe288 +------------------+
                       |0x00000058        |
        0x7fffffffe290 +------------------+
                       |0x00000063        |
        0x7fffffffe298 +------------------+
                       |                  |
        0x7fffffffe2a0 +------------------+
                       |                  |
        0x7fffffffe2a8 +------------------+
                       |        0xffffffff|
        0x7fffffffe2b0 +------------------+
                       |0x00007fffffffe2d0|
        0x7fffffffe2b8 +------------------+
                       |0x0000000000400555|
        0x7fffffffe2c0 +------------------+
                       |                  |
        0x7fffffffe2c8 +------------------+
                       |                  |
        0x7fffffffe2d0 +------------------+
                       |                  |
        0x7fffffffe2d8 +------------------+
</code></pre>

<p>進める</p>

<pre><code>10        int s = -9999;
0x00000000004004b0 &lt;sum+24&gt;:    movl   $0xffffd8f1,-0x4(%rbp)
</code></pre>

<p>この命令後のレジスタの状態</p>

<pre><code>rcx            0x2c     44
rdx            0x21     33
rsi            0x16     22
rdi            0xb      11
rbp            0x7fffffffe270   0x7fffffffe270
rsp            0x7fffffffe270   0x7fffffffe270
r8             0x37     55
r9             0x42     66

        0x7fffffffe248 +------------------+
                       |0x00000042 0x00000037|
        0x7fffffffe250 +------------------+
                       |0x0000002c 0x00000021|
        0x7fffffffe258 +------------------+
                       |0x00000016 0x0000000b|
        0x7fffffffe260 +------------------+
                       |                  |
        0x7fffffffe268 +------------------+
                       |        0xffffd8f1| &lt;== -9999
rsp +--&gt;0x7fffffffe270 +------------------+
rbp +                  |0x00007fffffffe2b0|
        0x7fffffffe278 +------------------+
                       |0x0000000000400525|
        0x7fffffffe280 +------------------+
                       |0x0000004d        |
        0x7fffffffe288 +------------------+
                       |0x00000058        |
        0x7fffffffe290 +------------------+
                       |0x00000063        |
        0x7fffffffe298 +------------------+
                       |                  |
        0x7fffffffe2a0 +------------------+
                       |                  |
        0x7fffffffe2a8 +------------------+
                       |        0xffffffff|
        0x7fffffffe2b0 +------------------+
                       |0x00007fffffffe2d0|
        0x7fffffffe2b8 +------------------+
                       |0x0000000000400555|
        0x7fffffffe2c0 +------------------+
                       |                  |
        0x7fffffffe2c8 +------------------+
                       |                  |
        0x7fffffffe2d0 +------------------+
                       |                  |
        0x7fffffffe2d8 +------------------+
</code></pre>

<p>進める</p>

<pre><code>11
12        s = a1 + a2 + a3 + a4 + a5 + a6 + a7 + a8 + a9;
0x00000000004004b7 &lt;sum+31&gt;:    mov    -0x18(%rbp),%eax
0x00000000004004ba &lt;sum+34&gt;:    add    -0x14(%rbp),%eax
0x00000000004004bd &lt;sum+37&gt;:    add    -0x1c(%rbp),%eax
0x00000000004004c0 &lt;sum+40&gt;:    add    -0x20(%rbp),%eax
0x00000000004004c3 &lt;sum+43&gt;:    add    -0x24(%rbp),%eax
0x00000000004004c6 &lt;sum+46&gt;:    add    -0x28(%rbp),%eax
0x00000000004004c9 &lt;sum+49&gt;:    add    0x10(%rbp),%eax
0x00000000004004cc &lt;sum+52&gt;:    add    0x18(%rbp),%eax
0x00000000004004cf &lt;sum+55&gt;:    add    0x20(%rbp),%eax
0x00000000004004d2 &lt;sum+58&gt;:    mov    %eax,-0x4(%rbp)
</code></pre>

<p>この命令後のレジスタの状態</p>

<pre><code>rax            0x1ef    495

rcx            0x2c     44
rdx            0x21     33
rsi            0x16     22
rdi            0xb      11
rbp            0x7fffffffe270   0x7fffffffe270
rsp            0x7fffffffe270   0x7fffffffe270
r8             0x37     55
r9             0x42     66

        0x7fffffffe248 +------------------+
                       |0x00000042 0x00000037|
        0x7fffffffe250 +------------------+
                       |0x0000002c 0x00000021|
        0x7fffffffe258 +------------------+
                       |0x00000016 0x0000000b|
        0x7fffffffe260 +------------------+
                       |                  |
        0x7fffffffe268 +------------------+
                       |        0x000001ef| &lt;== 495
rsp +--&gt;0x7fffffffe270 +------------------+
rbp +                  |0x00007fffffffe2b0|
        0x7fffffffe278 +------------------+
                       |0x0000000000400525|
        0x7fffffffe280 +------------------+
                       |0x0000004d        |
        0x7fffffffe288 +------------------+
                       |0x00000058        |
        0x7fffffffe290 +------------------+
                       |0x00000063        |
        0x7fffffffe298 +------------------+
                       |                  |
        0x7fffffffe2a0 +------------------+
                       |                  |
        0x7fffffffe2a8 +------------------+
                       |        0xffffffff|
        0x7fffffffe2b0 +------------------+
                       |0x00007fffffffe2d0|
        0x7fffffffe2b8 +------------------+
                       |0x0000000000400555|
        0x7fffffffe2c0 +------------------+
                       |                  |
        0x7fffffffe2c8 +------------------+
                       |                  |
        0x7fffffffe2d0 +------------------+
                       |                  |
        0x7fffffffe2d8 +------------------+
</code></pre>

<p>進める</p>

<pre><code>13
14        return s;
0x00000000004004d5 &lt;sum+61&gt;:    mov    -0x4(%rbp),%eax
</code></pre>

<p>この命令後のレジスタの状態</p>

<pre><code>rax            0x1ef    495 &lt;== 戻り値が RAX に入っている

rcx            0x2c     44
rdx            0x21     33
rsi            0x16     22
rdi            0xb      11
rbp            0x7fffffffe270   0x7fffffffe270
rsp            0x7fffffffe270   0x7fffffffe270
r8             0x37     55
r9             0x42     66

        0x7fffffffe248 +------------------+
                       |0x00000042 0x00000037|
        0x7fffffffe250 +------------------+
                       |0x0000002c 0x00000021|
        0x7fffffffe258 +------------------+
                       |0x00000016 0x0000000b|
        0x7fffffffe260 +------------------+
                       |                  |
        0x7fffffffe268 +------------------+
                       |        0x000001ef|
rsp +--&gt;0x7fffffffe270 +------------------+
rbp +                  |0x00007fffffffe2b0|
        0x7fffffffe278 +------------------+
                       |0x0000000000400525|
        0x7fffffffe280 +------------------+
                       |0x0000004d        |
        0x7fffffffe288 +------------------+
                       |0x00000058        |
        0x7fffffffe290 +------------------+
                       |0x00000063        |
        0x7fffffffe298 +------------------+
                       |                  |
        0x7fffffffe2a0 +------------------+
                       |                  |
        0x7fffffffe2a8 +------------------+
                       |        0xffffffff|
        0x7fffffffe2b0 +------------------+
                       |0x00007fffffffe2d0|
        0x7fffffffe2b8 +------------------+
                       |0x0000000000400555|
        0x7fffffffe2c0 +------------------+
                       |                  |
        0x7fffffffe2c8 +------------------+
                       |                  |
        0x7fffffffe2d0 +------------------+
                       |                  |
        0x7fffffffe2d8 +------------------+
</code></pre>

<p>進める</p>

<pre><code>15      }
0x00000000004004d8 &lt;sum+64&gt;:    leaveq
</code></pre>

<p>この命令後のレジスタの状態</p>

<pre><code>rbp            0x7fffffffe2b0   0x7fffffffe2b0
rsp            0x7fffffffe278   0x7fffffffe278

        0x7fffffffe248 +------------------+
                       |0x00000042 0x00000037|
        0x7fffffffe250 +------------------+
                       |0x0000002c 0x00000021|
        0x7fffffffe258 +------------------+
                       |0x00000016 0x0000000b|
        0x7fffffffe260 +------------------+
                       |                  |
        0x7fffffffe268 +------------------+
                       |        0x000001ef|
        0x7fffffffe270 +------------------+
                       |0x00007fffffffe2b0|
rsp ---&gt;0x7fffffffe278 +------------------+
                       |0x0000000000400525|
        0x7fffffffe280 +------------------+
                       |0x0000004d        |
        0x7fffffffe288 +------------------+
                       |0x00000058        |
        0x7fffffffe290 +------------------+
                       |0x00000063        |
        0x7fffffffe298 +------------------+
                       |                  |
        0x7fffffffe2a0 +------------------+
                       |                  |
        0x7fffffffe2a8 +------------------+
                       |        0xffffffff|
rbp ---&gt;0x7fffffffe2b0 +------------------+  &lt;== ベースポインタが関数 sum 呼出直前に戻る
                       |0x00007fffffffe2d0|
        0x7fffffffe2b8 +------------------+
                       |0x0000000000400555|
        0x7fffffffe2c0 +------------------+
                       |                  |
        0x7fffffffe2c8 +------------------+
                       |                  |
        0x7fffffffe2d0 +------------------+
                       |                  |
        0x7fffffffe2d8 +------------------+
</code></pre>

<p>進める</p>

<pre><code>0x00000000004004d9 &lt;sum+65&gt;:    retq
</code></pre>

<p>この命令後のレジスタの状態</p>

<pre><code>rbp            0x7fffffffe2b0   0x7fffffffe2b0
rsp            0x7fffffffe280   0x7fffffffe280

rip            0x400525 0x400525 &lt;func+75&gt;      &lt;== 関数 func の戻り先アドレス

        0x7fffffffe248 +------------------+
                       |0x00000042 0x00000037|
        0x7fffffffe250 +------------------+
                       |0x0000002c 0x00000021|
        0x7fffffffe258 +------------------+
                       |0x00000016 0x0000000b|
        0x7fffffffe260 +------------------+
                       |                  |
        0x7fffffffe268 +------------------+
                       |        0x000001ef|
        0x7fffffffe270 +------------------+
                       |0x00007fffffffe2b0|
        0x7fffffffe278 +------------------+
                       |0x0000000000400525|
rsp --&gt; 0x7fffffffe280 +------------------+  &lt;== スタックポインタが関数 sum 呼出直前に戻る
                       |0x0000004d        |
        0x7fffffffe288 +------------------+
                       |0x00000058        |
        0x7fffffffe290 +------------------+
                       |0x00000063        |
        0x7fffffffe298 +------------------+
                       |                  |
        0x7fffffffe2a0 +------------------+
                       |                  |
        0x7fffffffe2a8 +------------------+
                       |        0xffffffff|
rbp ---&gt;0x7fffffffe2b0 +------------------+
                       |0x00007fffffffe2d0|
        0x7fffffffe2b8 +------------------+
                       |0x0000000000400555|
        0x7fffffffe2c0 +------------------+
                       |                  |
        0x7fffffffe2c8 +------------------+
                       |                  |
        0x7fffffffe2d0 +------------------+
                       |                  |
        0x7fffffffe2d8 +------------------+
</code></pre>

<p>関数 func に戻ってきた</p>

<pre><code>0x0000000000400525 &lt;func+75&gt;:   mov    %eax,-0x4(%rbp)   &lt;== 戻り値を RAX から受け取る
</code></pre>

<p>この命令後のレジスタの状態</p>

<pre><code>rax            0x1ef    495

rbp            0x7fffffffe2b0   0x7fffffffe2b0
rsp            0x7fffffffe280   0x7fffffffe280

        0x7fffffffe248 +------------------+
                       |0x00000042 0x00000037|
        0x7fffffffe250 +------------------+
                       |0x0000002c 0x00000021|
        0x7fffffffe258 +------------------+
                       |0x00000016 0x0000000b|
        0x7fffffffe260 +------------------+
                       |                  |
        0x7fffffffe268 +------------------+
                       |        0x000001ef|
        0x7fffffffe270 +------------------+
                       |0x00007fffffffe2b0|
        0x7fffffffe278 +------------------+
                       |0x0000000000400525|
rsp --&gt; 0x7fffffffe280 +------------------+
                       |0x0000004d        |
        0x7fffffffe288 +------------------+
                       |0x00000058        |
        0x7fffffffe290 +------------------+
                       |0x00000063        |
        0x7fffffffe298 +------------------+
                       |                  |
        0x7fffffffe2a0 +------------------+
                       |                  |
        0x7fffffffe2a8 +------------------+
                       |        0x000001ef|  &lt;== 戻り値を RAX から受け取って格納された
rbp ---&gt;0x7fffffffe2b0 +------------------+
                       |0x00007fffffffe2d0|
        0x7fffffffe2b8 +------------------+
                       |0x0000000000400555|
        0x7fffffffe2c0 +------------------+
                       |                  |
        0x7fffffffe2c8 +------------------+
                       |                  |
        0x7fffffffe2d0 +------------------+
                       |                  |
        0x7fffffffe2d8 +------------------+
</code></pre>

<p>進める</p>

<pre><code>22
23        printf("sum: %d\n", ret);
0x0000000000400528 &lt;func+78&gt;:   mov    -0x4(%rbp),%esi
0x000000000040052b &lt;func+81&gt;:   mov    $0x400658,%edi
0x0000000000400530 &lt;func+86&gt;:   mov    $0x0,%eax
0x0000000000400535 &lt;func+91&gt;:   callq  0x400398 &lt;printf@plt&gt;
</code></pre>

<p>この命令後のレジスタの状態(printf 関数から返った直後)</p>

<pre><code>rax            0x9      9      &lt;=== printf からの戻り値(出力バイト数なので9バイト, "sum: 495\n")

rsi            0x2aaaaaaac000   46912496123904  &lt;== printf の中で使用されたので変わっている
rdi            0x1      1                       &lt;== printf の中で使用されたので変わっている
rbp            0x7fffffffe2b0   0x7fffffffe2b0
rsp            0x7fffffffe280   0x7fffffffe280

rsp --&gt; 0x7fffffffe280 +------------------+  &lt;== スタックポインタより上位アドレス(この絵では↓)は printf 呼出前と同じ
                       |0x0000004d        |
        0x7fffffffe288 +------------------+
                       |0x00000058        |
        0x7fffffffe290 +------------------+
                       |0x00000063        |
        0x7fffffffe298 +------------------+
                       |                  |
        0x7fffffffe2a0 +------------------+
                       |                  |
        0x7fffffffe2a8 +------------------+
                       |        0x000001ef|
rbp ---&gt;0x7fffffffe2b0 +------------------+
                       |0x00007fffffffe2d0|
        0x7fffffffe2b8 +------------------+
                       |0x0000000000400555|
        0x7fffffffe2c0 +------------------+
                       |                  |
        0x7fffffffe2c8 +------------------+
                       |                  |
        0x7fffffffe2d0 +------------------+
                       |                  |
        0x7fffffffe2d8 +------------------+
</code></pre>

<p>進める</p>

<pre><code>24      }
0x000000000040053a &lt;func+96&gt;:   leaveq
0x000000000040053b &lt;func+97&gt;:   retq
</code></pre>

<p>この命令後のレジスタの状態</p>

<pre><code>rbp            0x7fffffffe2d0   0x7fffffffe2d0  &lt;== 関数 func 呼出直前に戻っている
rsp            0x7fffffffe2c0   0x7fffffffe2c0  &lt;== 関数 func 呼出直前に戻っている

rip            0x400555 0x400555 &lt;main+25&gt;      &lt;== 関数 main の戻り先アドレス

        0x7fffffffe280 +------------------+ 
                       |0x0000004d        |
        0x7fffffffe288 +------------------+
                       |0x00000058        |
        0x7fffffffe290 +------------------+
                       |0x00000063        |
        0x7fffffffe298 +------------------+
                       |                  |
        0x7fffffffe2a0 +------------------+
                       |                  |
        0x7fffffffe2a8 +------------------+
                       |        0x000001ef|
        0x7fffffffe2b0 +------------------+
                       |0x00007fffffffe2d0|
        0x7fffffffe2b8 +------------------+
                       |0x0000000000400555|
rsp --&gt; 0x7fffffffe2c0 +------------------+
                       |                  |
        0x7fffffffe2c8 +------------------+
                       |                  |
rbp --&gt; 0x7fffffffe2d0 +------------------+
                       |                  |
        0x7fffffffe2d8 +------------------+
</code></pre>

<h2>参考</h2>

<ul>
<li><a href="http://en.wikipedia.org/wiki/X86_calling_conventions#x86-64_calling_conventions">x86 calling conventions</a></li>
<li><a href="http://ja.wikipedia.org/wiki/%E5%91%BC%E5%87%BA%E8%A6%8F%E7%B4%84#System_V_AMD64_ABI_.E5.91.BC.E5.87.BA.E8.A6.8F.E7.B4.84">呼出規約</a></li>
<li><a href="http://x86-64.org/documentation/abi.pdf">System V Application Binary Interface AMD64 Architecture Processor Supplement</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[GDB] 別環境で採取した core ファイルを解析する方法]]></title>
    <link href="http://th0x4c.github.com/blog/2012/10/10/gdb-analyze-a-core-file/"/>
    <updated>2012-10-10T20:28:00+09:00</updated>
    <id>http://th0x4c.github.com/blog/2012/10/10/gdb-analyze-a-core-file</id>
    <content type="html"><![CDATA[<h2>目的</h2>

<p>別環境で採取した core ファイルを解析する。</p>

<h2>環境</h2>

<ul>
<li>OS: Oracle Enterprise Linux 5.8</li>
<li>GDB: GNU gdb 7.0.1-42.el5</li>
</ul>


<h2>解析に必要なファイル</h2>

<p>別環境で発生した core ファイルを解析するためには以下のファイルが必要。</p>

<ul>
<li>core ファイル</li>
<li>実行ファイル</li>
<li>共有ライブラリ</li>
</ul>


<p>例えば、以下のように <code>abort()</code> でわざと core を吐かせて試してみる。</p>

<pre><code>$ cat hello.c
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

int main(int argc, char *argv[])
{
  printf("hello, world\n");
  abort();
  return 0;
}

$ gcc -o hello hello.c
$ ./hello
hello, world
Aborted (core dumped)
$ ls -ltr | tail -1
-rw------- 1 oracle oinstall 184320 Oct 10 20:59 core.7441
</code></pre>

<p>core.7441 という core ファイルが吐かれた。</p>

<p>実行ファイルは core ファイルに対して <code>file</code> コマンドを実行すれば確認できる。</p>

<pre><code>$ file core.7441
core.7441: ELF 64-bit LSB core file AMD x86-64, version 1 (SYSV), SVR4-style, from 'hello'
</code></pre>

<p><code>hello</code> という実行ファイルによってこの core が吐かれたことが分かる。</p>

<p>共有ライブラリは GDB で core を読み込んで <code>info share</code> で確認できる。</p>

<pre><code>$ gdb ./hello ./core.7441 
GNU gdb (GDB) Red Hat Enterprise Linux (7.0.1-42.el5)
Copyright (C) 2009 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "x86_64-redhat-linux-gnu".
For bug reporting instructions, please see:
&lt;http://www.gnu.org/software/gdb/bugs/&gt;...
Reading symbols from /tmp/hello...(no debugging symbols found)...done.
[New Thread 7441]
Reading symbols from /lib64/libc.so.6...(no debugging symbols found)...done.
Loaded symbols for /lib64/libc.so.6
Reading symbols from /lib64/ld-linux-x86-64.so.2...(no debugging symbols found)...done.
Loaded symbols for /lib64/ld-linux-x86-64.so.2
Core was generated by `./hello'.
Program terminated with signal 6, Aborted.
#0  0x00000037be430265 in raise () from /lib64/libc.so.6
(gdb) info share
From                To                  Syms Read   Shared Object Library
0x00000037be41d780  0x00000037be50ad68  Yes (*)     /lib64/libc.so.6
0x00000037be000a70  0x00000037be01682e  Yes (*)     /lib64/ld-linux-x86-64.so.2
(*): Shared library is missing debugging information.
</code></pre>

<p>共有ライブラリとしては以下が読み込まれていることが分かる。</p>

<ul>
<li>/lib64/libc.so.6</li>
<li>/lib64/ld-linux-x86-64.so.2</li>
</ul>


<p>なお、実行中に動的リンクを行うようなプログラムでなければ、共有ライブラリは <code>ldd</code> コマンドでも確認できる。</p>

<pre><code>$ ldd ./hello
        linux-vdso.so.1 =&gt;  (0x00007fffcd1ff000)
        libc.so.6 =&gt; /lib64/libc.so.6 (0x00000037be400000)
        /lib64/ld-linux-x86-64.so.2 (0x00000037be000000)
</code></pre>

<p>以上より、この例では他の環境でこの core ファイルを解析するためには次のファイルを採取する必要がある。</p>

<ul>
<li>core ファイル => core.7441</li>
<li>実行ファイル => hello</li>
<li>共有ライブラリ => /lib64/libc.so.6, /lib64/ld-linux-x86-64.so.2</li>
</ul>


<h2>別環境での core の解析</h2>

<p>別環境に先ほど採取したファイルを展開する。
今回は以下のように配置した。</p>

<pre><code>/tmp/core.7441
/tmp/bin/hello
/tmp/lib/libc.so.6
/tmp/lib/ld-linux-x86-64.so.2
</code></pre>

<p>GDB でこの core を解析するためには、採取した共有ライブラリを読み込むために以下のように <code>solib-absolute-prefix</code>, <code>solib-search-path</code> を設定する。</p>

<pre><code>$ cd /tmp
$ gdb
(gdb) set solib-absolute-prefix /tmp/lib
(gdb) set solib-search-path /tmp/lib
(gdb) file ./bin/hello
(gdb) core-file ./core.7441 
</code></pre>

<p>実際の実行例は以下。</p>

<pre><code>$ gdb
GNU gdb (GDB) Red Hat Enterprise Linux (7.0.1-42.el5)
Copyright (C) 2009 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "x86_64-redhat-linux-gnu".
For bug reporting instructions, please see:
&lt;http://www.gnu.org/software/gdb/bugs/&gt;.
(gdb) set solib-absolute-prefix /tmp/lib
(gdb) set solib-search-path /tmp/lib
(gdb) file ./bin/hello
Reading symbols from /tmp/bin/hello...(no debugging symbols found)...done.
(gdb) core-file ./core.7441 
[New Thread 7441]
Reading symbols from /tmp/lib/libc.so.6...(no debugging symbols found)...done.
Loaded symbols for /tmp/lib/libc.so.6
Reading symbols from /tmp/lib/ld-linux-x86-64.so.2...(no debugging symbols found)...done.
Loaded symbols for /tmp/lib/ld-linux-x86-64.so.2
Core was generated by `./hello'.
Program terminated with signal 6, Aborted.
#0  0x00000037be430265 in raise () from /tmp/lib/libc.so.6
(gdb) bt
#0  0x00000037be430265 in raise () from /tmp/lib/libc.so.6
#1  0x00000037be431d10 in abort () from /tmp/lib/libc.so.6
#2  0x00000000004004f6 in main ()
</code></pre>

<h3>ソースファイル</h3>

<p>デバックオプション(-g オプション)付きでコンパイルされている場合は、ソースファイルがあればソースコードを使用した調査ができる。
コンパイルした環境と別の環境で core 解析する場合、ソースコードを入手して、GDB の <code>directory</code> にてソースファイルを展開したディレクトリを指定する。</p>

<p>実行例は以下。(実行ファイルはデバックオプション付きでコンパイルしたものを使用)</p>

<pre><code>(gdb) bt
#0  0x00000030ea830265 in raise () from /tmp/lib/libc.so.6
#1  0x00000030ea831d10 in abort () from /tmp/lib/libc.so.6
#2  0x00000000004004f6 in main (argc=1, argv=0x7fff9d995df8) at hello.c:7
(gdb) frame 2
#2  0x00000000004004f6 in main (argc=1, argv=0x7fff9d995df8) at hello.c:7
7   hello.c: No such file or directory.
    in hello.c
(gdb) list
2     in hello.c
</code></pre>

<p>ソースファイルが見つからないと上記のようにソースコードが必要な調査ができない。
<code>directory</code> にてソースファイルを展開したディレクトリを指定すると、ソースコードを元にした調査ができる。
(ディレクトリが複数ある場合は<code>:</code>で区切って複数指定するか、<code>directory</code> をディレクトリの分だけ実行すれば追加される)</p>

<pre><code>(gdb) directory /tmp/src
Source directories searched: /tmp/src:$cdir:$cwd
(gdb) frame 2
#2  0x00000000004004f6 in main (argc=1, argv=0x7fff9d995df8) at hello.c:7
7         abort();
(gdb) list
2       #include &lt;stdlib.h&gt;
3       
4       int main(int argc, char *argv[])
5       {
6         printf("hello, world\n");
7         abort();
8         return 0;
9       }
</code></pre>
]]></content>
  </entry>
  
</feed>
